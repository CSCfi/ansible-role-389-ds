---
# tasks file for 389-ds
- name: Add Epel repository
  yum: 
    name: epel-release 
    state: present
  when: ansible_os_family == "RedHat" or ansible_os_family == "Centos"

- name: Add host | Add IP and FQDN to /etc/hosts
  lineinfile:
    path: /etc/hosts
    regexp: "^{{ ansible_default_ipv4.address }}"
    line: "{{ ansible_default_ipv4.address }} {{ dirsrv_fqdn }} {{ dirsrv_hostname }}"
  tags:
    - configure

- name: 389-ds | Initialize
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_os_family }}.yml"
    - "default.yml"
  when: __dirsrv_packages is not defined or dirsrv_service_name is not defined
  tags:
    - 389-ds
    - install

- name: 389-ds | Define | Packages
  set_fact:
    dirsrv_packages: "{{ __dirsrv_packages | list }}"
  when: dirsrv_packages is not defined
  tags:
    - 389-ds
    - install

- name: 389-ds | Install packages
  yum:
    name: "{{ item }}" #"{{ dirsrv_state }}"
    state: present
  with_items: "{{ dirsrv_packages }}"
  tags:
    - 389-ds
    - install

- name: Sysctl | Configure
  sysctl:
    name: "{{item.name}}"
    value: "{{item.value}}"
    sysctl_set: yes
    state: present
  with_items:
    - { name: net.ipv4.tcp_keepalive_time, value: 300 }
    - { name: net.ipv4.ip_local_port_range, value: "1024 65000" }
    - { name: fs.file-max, value: 64000 }
  when: dirsrv_fqdn != "local.dev"
  tags:
    - sysctl
    - configure
      
- name: Dirsrv systemd service | Configure file descriptors 
  lineinfile:
    path: /etc/sysconfig/dirsrv.systemd
    state: present
    insertafter: "^[Service]"
    line: LimitNOFILE=8192
  when: dirsrv_fqdn != "local.dev"
  tags:
    - 389-ds
    - systemd

- name: 389-ds | Silent setup file 
  template: 
    src: templates/dirsrv.inf 
    dest: /tmp/dirsrv.inf
  tags:
    - 389-ds

- name: 389-ds | setup-ds-admin.pl | Execute | {{ dirsrv_hostname }} | {{ dirsrv_fqdn }} | {{ dirsrv_suffix }} 
  shell: /usr/sbin/{{ dirsrv_setupdsadmin }} --silent --file=/tmp/dirsrv.inf --logfile=/tmp/389install.log creates=/etc/dirsrv/slapd-{{ dirsrv_hostname }}/dse.ldif

# Enabled services in order to connect to directory server
- name: 389-ds | Enable | service
  service:
    name: "{{ item }}"
    state: started
    enabled: yes
  with_items: 
    - dirsrv.target
    - dirsrv-admin.service

